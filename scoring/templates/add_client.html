<!DOCTYPE html>
<html lang="ko">
<head>
  <title>투사 기반 로르샤흐 검사 채점 프로그램 필수 입력 정보</title>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0,minimum-scale=0,maximum-scale=10">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/css/bootstrap.min.css" integrity="sha384-zCbKRCUGaJDkqS1kPbPd7TveP5iyJE0EjAuZQTgFLD2ylzuqKfdKlfG/eSrtxUkn" crossorigin="anonymous">
  <style>
    body{display:flex;justify-content:center;align-items:flex-start;min-height:100vh;margin:0;background:#f2f2f2;padding:24px}
    .form-container{max-width:700px;width:100%;background:#fff;padding:24px;border-radius:8px;box-shadow:0 4px 16px rgba(0,0,0,.08)}
    .form-group{margin-bottom:16px}
    .section-title{font-size:18px;font-weight:600;margin-top:12px;margin-bottom:12px}
    .subtext{font-size:12px;color:#6c757d}
    .hidden{display:none}
    .inline-consent input[type="checkbox"]{
    margin-left: 6px;
    transform: translateY(1px);
    }
  </style>
</head>
<script>
  (function () {
    function attachYMDMask(inputId) {
      var el = document.getElementById(inputId);
      if (!el) return;

      el.addEventListener('input', function (e) {
        var v = e.target.value.replace(/\D/g, '').slice(0, 8); // YYYYMMDD
        var y = v.slice(0, 4);
        var m = v.slice(4, 6);
        var d = v.slice(6, 8);

        var out = y;
        if (m.length) out += '-' + m;
        if (d.length) out += '-' + d;

        e.target.value = out;
      });

      el.addEventListener('paste', function (e) {
        e.preventDefault();
        var text = (e.clipboardData || window.clipboardData).getData('text');
        var digits = text.replace(/\D/g, '').slice(0, 8);
        var y = digits.slice(0, 4), m = digits.slice(4, 6), d = digits.slice(6, 8);
        e.target.value = y + (m ? '-' + m : '') + (d ? '-' + d : '');
      });
    }

    attachYMDMask('id_birthdate');
    attachYMDMask('id_testDate');
  })();
</script>
<body>
  <div class="form-container">
    <h3 class="text-center mb-3">투사 기반 로르샤흐 검사 채점 프로그램 필수 입력 정보</h3>
    <form method="post" novalidate>
      {% csrf_token %}
      <input type="hidden" name="next" value="{{ request.GET.next|default:'intermediate' }}">

      <div class="form-group">
        <div class="d-flex align-items-center inline-consent">
            <label for="id_consent" class="mb-0 mr-2">데이터 연구활용 동의</label>
            {{ form.consent }}
        </div>
        <p class="subtext mt-1">
          * 채점 정보는 익명 형태로 통계처리되어 학술적 목적으로 사용됩니다.<br>
          * 수검자에게 해당 사실에 대한 동의를 구한 후 이용 바랍니다.
        </p>
      </div>

      <div class="form-group">
        <label for="id_examiner_name">1. 검사자 이름(실명)</label>
        {{ form.examiner_name }}
      </div>

      <div class="form-row">
        <div class="form-group col-md-6">
          <label for="id_name">2. 수검자 이름(실명)</label>
          {{ form.name }}
        </div>
        <div class="form-group col-md-6">
          <label for="id_gender">3. 수검자 성별</label>
          {{ form.gender }}
          <small class="subtext d-block"></small>
        </div>
      </div>

      <div class="form-group">
        <label for="id_birthdate">4. 수검자 생년월일</label>
        {{ form.birthdate }}
        <small class="subtext d-block">YYYY-MM-DD 형식 (예: 2000-08-01)</small>
      </div>

      <div class="form-group">
        <label for="id_testDate">5. 검사일</label>
        {{ form.testDate }}
        <small class="subtext d-block">YYYY-MM-DD 형식 (예: 2023-05-01)</small>
      </div>

      <p class="subtext">
        * 입력해주신 정보를 바탕으로 검사 당시 연령을 계산합니다.<br>
        * 연령 규준을 참고하여 결과를 산출하니 특히 아동의 경우 정확히 입력해주세요.
      </p>

      <div class="form-group">
        <label for="id_evaluation_purpose">6. 평가 목적</label>
        {{ form.evaluation_purpose }}
      </div>

      <div class="form-group">
        <label for="id_rorschach_history">7. 로르샤흐 검사 수검 이력</label>
        {{ form.rorschach_history }}
        <small class="subtext d-block">선택지: 0회 / 1회 / 2회 / 3회 이상</small>
      </div>

      <div class="form-group">
        <label for="id_current_psych_treatment">8. 현재 정신과 치료 유무</label>
        {{ form.current_psych_treatment }}
        <small class="subtext d-block">선택지: 없음 / 치료중</small>
      </div>
      <div id="current_dx_wrap" class="form-group hidden">
        <label for="id_current_psych_dx">진단명(현재)</label>
        {{ form.current_psych_dx }}
      </div>

      <div class="form-group">
        <label for="id_past_psych_treatment">9. 과거 정신과 치료 유무</label>
        {{ form.past_psych_treatment }}
        <small class="subtext d-block">선택지: 없음 / 치료받은 적 있음</small>
      </div>
      <div id="past_dx_wrap" class="form-group hidden">
        <label for="id_past_psych_dx">진단명(과거)</label>
        {{ form.past_psych_dx }}
      </div>

      <div class="form-group">
        <label for="id_notes">비고</label>
        {{ form.notes }}
      </div>

      {% if form.errors %}
        <div class="text-danger mb-3">
          {{ form.non_field_errors }}
          {% for field in form %}
            {% for error in field.errors %}
              <div>{{ field.label }}: {{ error }}</div>
            {% endfor %}
          {% endfor %}
        </div>
      {% endif %}

      <div class="text-right">
        <button type="submit" class="btn btn-primary">저장하기</button>
      </div>
    </form>
  </div>

  <script>
    (function () {
      function toggleDx(selectId, wrapId, positiveValue) {
        var sel = document.getElementById(selectId);
        var wrap = document.getElementById(wrapId);
        if (!sel || !wrap) return;
        function apply() {
          if (sel.value === positiveValue) {
            wrap.classList.remove('hidden');
          } else {
            wrap.classList.add('hidden');
            var input = wrap.querySelector('input');
            if (input) input.value = '';
          }
        }
        sel.addEventListener('change', apply);
        apply();
      }
      toggleDx('id_current_psych_treatment', 'current_dx_wrap', 'treat');
      toggleDx('id_past_psych_treatment', 'past_dx_wrap', 'yes');
    })();
  </script>
</body>
</html>
